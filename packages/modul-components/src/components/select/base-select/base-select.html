<div class="m-base-select">
    <div v-m-popup:popup
         class="m-base-select__popup"
         :style="{ width: inputMaxWidth }">
        <slot :toggle="togglePopup"
              :key-up="onKeydownUp"
              :key-down="onKeydownDown"
              :key-tab="onKeydownTab"
              :key-esc="onKeydownEsc"
              :key-enter="onKeydownEnter"
              :key-space="onKeydownSpace"></slot>
    </div>
    <m-popup ref="popup"
             placement="bottom-start"
             :open.sync="internalOpen"
             :disabled="!active"
             :enter="transitionEnter"
             :leave="transitionLeave"
             :padding="false"
             :preload="true"
             :lazy="false"
             :focus-management="false"
             :close-on-backdrop="true"
             :open-trigger="'manual'"
             :sidebar-full-height="sidebarFullHeight"
             @open="onOpen"
             @close="onClose">
        <template slot="header">
            <slot name="popup-header"
                  :key-up="onKeydownUp"
                  :key-down="onKeydownDown"
                  :key-tab="onKeydownTab"
                  :key-esc="onKeydownEsc"
                  :key-enter="onKeydownEnter"
                  :key-space="onKeydownSpace">
            </slot>
        </template>

        <ul :id="ariaControls"
            :class="{ 'm--is-virutalScroll': virtualScroll }"
            class="m-base-select__list"
            ref="items"
            :aria-labelledby="controlId"
            aria-live="polite"
            :style="{ minWidth: inputMaxWidth }">
            <template v-if="virtualScroll">
                <virtual-list :size="virtualScrollItemHeight"
                              :remain="4"
                              class="m-base-select__virtuallist">
                    <template v-for="(item, index) of items">
                        <slot name="outer-items"
                              :item="item"
                              :index="index"
                              :props="getItemProps(item, index)"
                              :handlers="getItemHandlers(item, index)">
                            <m-select-item :key="index"
                                           v-bind="getItemProps(item, index)"
                                           v-on="getItemHandlers(item, index)">
                                <slot name="items"
                                      :item="item"
                                      :index="index"><span v-html="item"></span></slot>
                            </m-select-item>
                        </slot>
                    </template>
                </virtual-list>
            </template>
            <template v-else>
                <template v-for="(item, index) of items">
                    <slot name="outer-items"
                          :item="item"
                          :props="getItemProps(item, index)"
                          :handlers="getItemHandlers(item, index)">
                        <m-select-item v-bind="getItemProps(item, index)"
                                       v-on="getItemHandlers(item, index)">
                            <slot name="items"
                                  :item="item"
                                  :index="index"><span v-html="item"></span></slot>
                        </m-select-item>
                    </slot>
                </template>
            </template>
        </ul>
    </m-popup>
</div>
