<m-base-select
    ref="baseSelect"
    :control-id="id"
    :active="active"
    :items="options"
    :selected-items="selectedItems"
    :open.sync="open"
    :input-max-width="inputMaxWidth"
    :close-on-select="false"
    :hide-radio-button-mobile="true"
    :enable-animation="!linkSelectAll"
    :width="width"
    :max-width="maxWidth"
    :multiselect="true"
    :listbox-aria-labelledby="label ? labelId : undefined"
    @open="emitOpen"
    @close="emitClose"
    @select-item="onSelect"
    @click-on-item="onClickOnItem"
    @portal-after-close="onPortalAfterClose"
>
    <template #default="scope">
        <m-input-style
            class="m-multi-select"
            :class="{
                'm--is-open': open,
                'm--is-disabled': isDisabled,
                'm--is-waiting': isWaiting
            }"
            :style="{ width: inputWidth, maxWidth: inputMaxWidth }"
            :label="label"
            :label-id="labelId"
            :label-for="id"
            :disabled="isDisabled"
            :waiting="isWaiting"
            :focus="internalIsFocus"
            :label-up="labelUp"
            :empty="isEmpty"
            :error="hasError"
            :cursor-pointer="true"
            :valid="isValid"
            :required-marker="requiredMarker"
            :tag-style="tagStyle"
            @click.prevent="onInputStyleClick(scope.toggle)"
        >
            <div
                ref="input"
                class="m-multi-select__chips"
                role="button"
                tabindex="0"
                aria-haspopup="listbox"
                :aria-controls="scope.ariaControls"
                :aria-labelledby="label ? labelId : undefined"
                :aria-describedby="`${inputAriaDescribedby} ${selectedValueId}`"
                :aria-activedescendant="scope.ariaActivedescendant"
                :aria-required="required || requiredMarker"
                @focus="onFocus"
                @blur="onBlur"
                @keydown.up.prevent="onKeydownUp"
                @keydown.down.prevent="onKeydownDown"
                @keydown.enter.prevent="onKeydownEnter"
                @keydown.return.prevent="onKeydownEnter"
                @keydown.space.prevent="onKeydownEnter"
                @keydown.home.prevent="scope.keyHome"
                @keydown.end.prevent="scope.keyEnd"
                @keydown.esc="scope.keyEsc"
                @keydown.tab="scope.keyTab"
                @keydown="scope.keyLetter"
            >
                <input
                    v-if="numberOfItemsSelected === 0"
                    :placeholder="placeholder"
                    type="text"
                    readonly
                    tabindex="-1"
                    :aria-labelledby="label ? labelId : undefined"
                />
                <m-chip-delete
                    v-if="chipsDisplayMode === 1"
                    class="m-multi-select__chip"
                    size="small"
                    tabindex="-1"
                    @delete="onDeleteAll()"
                >
                    <slot name="chips-all">
                        {{ textNumberOfSelectedItems }}
                    </slot>
                </m-chip-delete>

                <template v-else-if="chipsDisplayMode === 0">
                    <m-chip-delete
                        v-for="item, index in internalValue.slice(0, maxVisibleChips)"
                        class="m-multi-select__chip"
                        :key="index"
                        size="small"
                        tabindex="-1"
                        @delete="onDelete(index)"
                    >
                        <slot
                            name="chips"
                            :item="item"
                            :index="index"
                        >
                            {{ getChipLabel(item) }}
                        </slot>
                    </m-chip-delete>
                    <span class="m-multi-select__more">
                        <slot name="more">
                            {{ textNumberOfUnselectedItemsLeft }}
                        </slot>
                    </span>
                </template>
                <template v-else-if="chipsDisplayMode === -1">
                    <m-chip-delete
                        v-for="item, index in internalValue"
                        class="m-multi-select__chip"
                        :key="index"
                        size="small"
                        tabindex="-1"
                        @delete="onDelete(index)"
                    >
                        <slot
                            name="chips"
                            :item="item"
                            :index="index"
                        >
                            {{ getChipLabel(item) }}
                        </slot>
                    </m-chip-delete>
                </template>
                <div :id="selectedValueId" class="m-multi-select__visually-hidden" aria-hidden="true">
                    {{ $i18n.translate('m-multi-select:selected-items') }}: {{ internalValue.join(', ') }}
                </div>

            </div>
            <div
                v-if="active"
                slot="suffix"
                class="m-multi-select__arrow"
                :class="{ 'm--is-open': open }"
            >
                <m-icon
                    ref="arrow"
                    class="m-multi-select__arrow__icon"
                    name="m-svg__arrow-head-filled--down"
                    size="16px"
                    :disabled="!active"
                    @keydown.enter.prevent="open = active"
                >
                    {{ !open ? $i18n.translate('m-multi-select:open') : $i18n.translate('m-multi-select:close')}}
                </m-icon>
            </div>
        </m-input-style>

    </template>

    <div
        :id="inputAriaDescribedby"
        slot="validation-message"
    >
        <m-validation-message
            class="m-multi-select__validation-message"
            :class="{ 'm--has-validation-message': hasValidationMessage }"
            :disabled="isDisabled"
            :waiting="isWaiting"
            :error="hasError"
            :valid="isValid"
            :error-message="errorMessage"
            :valid-message="validMessage"
            :helper-message="helperMessage"
        />
    </div>
    <template v-if="linkSelectAll"
              #popup-header>
        <m-select-item
            class="m-multi-select__popup-header"
            :focused="selectAllFocused"
            :hide-radio-button-mobile="true"
            @click="onToggleAll"
        >
            {{ allSelected ? $i18n.translate('m-multi-select:link-deselect-all') : $i18n.translate('m-multi-select:link-select-all') }}
        </m-select-item>
    </template>
    <template #items="{item , index}">
        <slot
            name="items"
            :item="item"
            :index="index"
        >
            <span v-html="item"></span>
        </slot>
    </template>
</m-base-select>
